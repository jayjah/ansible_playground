global:
  scrape_interval:     {{ scrape_interval }} # By default, scrape targets every 15 seconds.

  external_labels:
    monitor: 'server-monitor'

rule_files:
  - '/etc/prometheus/alert.rules'

scrape_configs:
  - job_name: 'prometheus'
    static_configs:
      - targets: ['localhost:{{ prometheus_port }}']
  - job_name: 'prometheus-cadvisor'
    static_configs:
      - targets: ['localhost:{{ cadvisor_metrics_port }}']
  - job_name: 'prometheus-docker'
    static_configs:
      - targets: ['172.17.0.1:9323']
  - job_name: 'prometheus-alertmanager'
    static_configs:
      - targets: ['localhost:9093']
  - job_name: 'prometheus-node-exporter'
    static_configs:
      - targets: ['localhost:{{ node_metrics_port }}']
  - job_name: 'prometheus-restic'
    static_configs:
      - targets: ['localhost:{{ restic_port }}']
    basic_auth:
      username: {{ hostvars[groups['resticclients'][0]]['restic_client_user'] }}
      password: {{ hostvars[groups['resticclients'][0]]['restic_client_password'] }}

  {% for item in groups['servers'] if hostvars[item]['name'] != 'metricsandbackups' -%}
  - job_name: '{{ hostvars[item]['name'] }}-cadvisor'
    static_configs:
      - targets: [ '{{ hostvars[item]['network_ip'] }}:{{ cadvisor_metrics_port }}' ]
  {% endfor %}

  {% for item in groups['servers'] if hostvars[item]['name'] != 'metricsandbackups' -%}
  - job_name: '{{ hostvars[item]['name'] }}-node-exporter'
    static_configs:
      - targets: [ '{{ hostvars[item]['network_ip'] }}:{{ node_metrics_port }}' ]
  {% endfor %}

  {% for item in groups['servers'] if hostvars[item]['name'] != 'metricsandbackups' -%}
  - job_name: '{{ hostvars[item]['name'] }}-docker'
    static_configs:
      - targets: [ '{{ hostvars[item]['network_ip'] }}:9323' ]
  {% endfor %}

alerting:
  alertmanagers:
    - static_configs:
      - targets: ['localhost:9093']
