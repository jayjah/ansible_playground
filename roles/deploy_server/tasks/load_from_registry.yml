---
- name: Install promtail-server-config.yaml file
  template:
    src: templates/prometheus/promtail-server-config.yaml.j2
    dest: "/home/{{ username }}/promtail-config.yaml"
    force: yes

- name: Run promtail docker image
  docker_container:
    name: "promtail"
    image: "grafana/promtail:2.3.0"
    recreate: true
    restart: false
    restart_policy: unless-stopped
    network_mode: host
    volumes:
      - /home/{{ username }}/promtail-config.yaml:/mnt/config/promtail-config.yaml:ro
      - /var/lib/docker/:/var/lib/docker:ro
      - /var/log/nginx/:/var/lib/docker:ro
    command:
      - "--config.file=/mnt/config/promtail-config.yaml"
    output_logs: yes
    interactive: yes
    tty: yes
    pull: yes
    log_driver: "json-file"
    log_options:
      #  loki-url: "http://{{ metrics_ip }}:{{ loki_port }}/loki/api/v1/push"
      #  mode: "non-blocking"
      #  loki-retries: '5'
      max-size: '10m'
      labels: "promtail"
      max-file: '3'
    #  loki-batch-size: '400'

- name: Run server docker image from registry
  docker_container:
    name: "{{ server_container_name }}-{{ name }}"
    image: "{{ server_registry_url }}{{ server_registry_image_name }}"
    recreate: true
    restart: false
    restart_policy: unless-stopped
    published_ports:
      - "{{ server_port }}:{{ server_port }}"
    mounts:
      - read_only=no,type=bind,source="/home/{{ username }}/backend/public",target=/app/public
    env_file: "/home/{{ username }}/backend/keys_config.env"
    output_logs: yes
    interactive: yes
    tty: yes
    pull: yes
    log_driver: "json-file"
    log_options:
    #  loki-url: "http://{{ metrics_ip }}:{{ loki_port }}/loki/api/v1/push"
    #  mode: "non-blocking"
    #  loki-retries: '5'
      max-size: '10m'
      labels: "backend"
      max-file: '3'
    #  loki-batch-size: '400'